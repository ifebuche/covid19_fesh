<<<<<<< HEAD
from io import BytesIO
=======
from io import StringIO
>>>>>>> 27dd9875f98c51b82553091a9dbcf027191524ef
import os

import numpy as np
import pytest

from pandas import DataFrame, date_range, read_csv
import pandas._testing as tm
from pandas.util import _test_decorators as td

<<<<<<< HEAD

@td.skip_if_no("gcsfs")
def test_read_csv_gcs(monkeypatch):
    from fsspec import AbstractFileSystem, registry

    registry.target.clear()  # noqa  # remove state

=======
from pandas.io.common import is_gcs_url


def test_is_gcs_url():
    assert is_gcs_url("gcs://pandas/somethingelse.com")
    assert is_gcs_url("gs://pandas/somethingelse.com")
    assert not is_gcs_url("s3://pandas/somethingelse.com")


@td.skip_if_no("gcsfs")
def test_read_csv_gcs(monkeypatch):
>>>>>>> 27dd9875f98c51b82553091a9dbcf027191524ef
    df1 = DataFrame(
        {
            "int": [1, 3],
            "float": [2.0, np.nan],
            "str": ["t", "s"],
            "dt": date_range("2018-06-18", periods=2),
        }
    )

<<<<<<< HEAD
    class MockGCSFileSystem(AbstractFileSystem):
        def open(*args, **kwargs):
            return BytesIO(df1.to_csv(index=False).encode())
=======
    class MockGCSFileSystem:
        def open(*args):
            return StringIO(df1.to_csv(index=False))
>>>>>>> 27dd9875f98c51b82553091a9dbcf027191524ef

    monkeypatch.setattr("gcsfs.GCSFileSystem", MockGCSFileSystem)
    df2 = read_csv("gs://test/test.csv", parse_dates=["dt"])

    tm.assert_frame_equal(df1, df2)


@td.skip_if_no("gcsfs")
def test_to_csv_gcs(monkeypatch):
<<<<<<< HEAD
    from fsspec import AbstractFileSystem, registry

    registry.target.clear()  # noqa  # remove state
=======
>>>>>>> 27dd9875f98c51b82553091a9dbcf027191524ef
    df1 = DataFrame(
        {
            "int": [1, 3],
            "float": [2.0, np.nan],
            "str": ["t", "s"],
            "dt": date_range("2018-06-18", periods=2),
        }
    )
<<<<<<< HEAD
    s = BytesIO()
    s.close = lambda: True

    class MockGCSFileSystem(AbstractFileSystem):
        def open(*args, **kwargs):
            s.seek(0)
=======
    s = StringIO()

    class MockGCSFileSystem:
        def open(*args):
>>>>>>> 27dd9875f98c51b82553091a9dbcf027191524ef
            return s

    monkeypatch.setattr("gcsfs.GCSFileSystem", MockGCSFileSystem)
    df1.to_csv("gs://test/test.csv", index=True)
<<<<<<< HEAD

    def mock_get_filepath_or_buffer(*args, **kwargs):
        return BytesIO(df1.to_csv(index=True).encode()), None, None, False

    monkeypatch.setattr(
        "pandas.io.common.get_filepath_or_buffer", mock_get_filepath_or_buffer
    )

    df2 = read_csv("gs://test/test.csv", parse_dates=["dt"], index_col=0)
=======
    df2 = read_csv(StringIO(s.getvalue()), parse_dates=["dt"], index_col=0)
>>>>>>> 27dd9875f98c51b82553091a9dbcf027191524ef

    tm.assert_frame_equal(df1, df2)


@td.skip_if_no("fastparquet")
@td.skip_if_no("gcsfs")
def test_to_parquet_gcs_new_file(monkeypatch, tmpdir):
    """Regression test for writing to a not-yet-existent GCS Parquet file."""
<<<<<<< HEAD
    from fsspec import AbstractFileSystem, registry

    registry.target.clear()  # noqa  # remove state
=======
>>>>>>> 27dd9875f98c51b82553091a9dbcf027191524ef
    df1 = DataFrame(
        {
            "int": [1, 3],
            "float": [2.0, np.nan],
            "str": ["t", "s"],
            "dt": date_range("2018-06-18", periods=2),
        }
    )

<<<<<<< HEAD
    class MockGCSFileSystem(AbstractFileSystem):
=======
    class MockGCSFileSystem:
>>>>>>> 27dd9875f98c51b82553091a9dbcf027191524ef
        def open(self, path, mode="r", *args):
            if "w" not in mode:
                raise FileNotFoundError
            return open(os.path.join(tmpdir, "test.parquet"), mode)

    monkeypatch.setattr("gcsfs.GCSFileSystem", MockGCSFileSystem)
    df1.to_parquet(
        "gs://test/test.csv", index=True, engine="fastparquet", compression=None
    )


<<<<<<< HEAD
=======
@td.skip_if_no("gcsfs")
def test_gcs_get_filepath_or_buffer(monkeypatch):
    df1 = DataFrame(
        {
            "int": [1, 3],
            "float": [2.0, np.nan],
            "str": ["t", "s"],
            "dt": date_range("2018-06-18", periods=2),
        }
    )

    def mock_get_filepath_or_buffer(*args, **kwargs):
        return (StringIO(df1.to_csv(index=False)), None, None, False)

    monkeypatch.setattr(
        "pandas.io.gcs.get_filepath_or_buffer", mock_get_filepath_or_buffer
    )
    df2 = read_csv("gs://test/test.csv", parse_dates=["dt"])

    tm.assert_frame_equal(df1, df2)


>>>>>>> 27dd9875f98c51b82553091a9dbcf027191524ef
@td.skip_if_installed("gcsfs")
def test_gcs_not_present_exception():
    with pytest.raises(ImportError) as e:
        read_csv("gs://test/test.csv")
        assert "gcsfs library is required" in str(e.value)
